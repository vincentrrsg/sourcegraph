load("@aspect_rules_js//js:defs.bzl", "js_library", "js_run_binary")
load("@npm//:defs.bzl", "npm_link_all_packages")
load("//dev:defs.bzl", "npm_package", "sass_library", "ts_project")
load("//client/shared/dev:generate_schema.bzl", "generate_schema")
load("//client/shared/dev:generate_graphql_operations.bzl", "generate_graphql_operations")
load("//client/shared/dev:tools.bzl", "module_style_typings")

# TODO(bazel): remove when no longer generated into src
# gazelle:exclude **/*.scss.d.ts

# gazelle:aspect_js_resolve **/*.scss :module_style_typings

npm_link_all_packages(name = "node_modules")

module_style_typings(
    name = "module_style_typings",
)

generate_graphql_operations(
    name = "graphql_operations",
    srcs = [
        ":graphql_operations_files",
    ],
    out = "src/graphql-operations.ts",
    interface_name = "SharedGraphQlOperations",
)

js_library(
    name = "graphql_operations_files",
    # Keep in sync with glob in client/shared/dev/generateGraphQlOperations.js
    srcs = glob(
        [
            "src/**/*.ts",
            "src/**/*.tsx",
        ],
        [
            "src/testing/**/*.*",
            # TODO: Ignore legacy build generated file as it conflicts with the Bazel
            # build. This can be removed after the migration.
            "src/schema.ts",
            "src/graphql-operations.ts",
        ],
    ),
    visibility = ["//client/shared:__pkg__"],
)

js_run_binary(
    name = "graphql_schema",
    outs = ["src/schema.ts"],
    args = [
        "src/schema.ts",
    ],
    chdir = package_name(),
    tool = "//client/shared/dev:generate_graphql_schema",
)

[generate_schema(
    name = name,
    out = "src/schema/%s.schema.d.ts" % name,
) for name in [
    "json-schema-draft-07",
    "site",
    "settings",
    "batch_spec",
]]

ts_project(
    name = "shared_lib",
    srcs = [
        "src/actions/ActionItem.tsx",
        "src/actions/ActionsContainer.tsx",
        "src/actions/ActionsNavItems.tsx",
        "src/actions/SimpleActionItem.tsx",
        "src/actions/actions.ts",
        "src/api/client/api/api.ts",
        "src/api/client/api/common.ts",
        "src/api/client/connection.ts",
        "src/api/client/enabledExtensions.ts",
        "src/api/client/mainthread-api.ts",
        "src/api/client/search.ts",
        "src/api/client/services/settings.ts",
        "src/api/client/types/textDocument.ts",
        "src/api/contract.ts",
        "src/api/extension/activation.ts",
        "src/api/extension/api/api.ts",
        "src/api/extension/api/callViewProvidersInParallel.ts",
        "src/api/extension/api/codeEditor.ts",
        "src/api/extension/api/common.ts",
        "src/api/extension/api/context/context.ts",
        "src/api/extension/api/contribution.ts",
        "src/api/extension/api/decorations.ts",
        "src/api/extension/api/directoryViewer.ts",
        "src/api/extension/api/documentHighlights.ts",
        "src/api/extension/api/getInsightsViews.ts",
        "src/api/extension/api/logging.ts",
        "src/api/extension/api/textDocument.ts",
        "src/api/extension/api/types.ts",
        "src/api/extension/api/utils/prefixSumComputer.ts",
        "src/api/extension/api/utils/wordHelpers.ts",
        "src/api/extension/api/workspaceRoot.ts",
        "src/api/extension/extensionApi.ts",
        "src/api/extension/extensionHost.ts",
        "src/api/extension/extensionHostApi.ts",
        "src/api/extension/extensionHostState.ts",
        "src/api/extension/main.worker.ts",
        "src/api/extension/test/test-helpers.ts",
        "src/api/extension/util.ts",
        "src/api/extension/utils/ReferenceCounter.ts",
        "src/api/extension/worker.ts",
        "src/api/features.ts",
        "src/api/integration-test/testHelpers.ts",
        "src/api/sharedEventLogger.ts",
        "src/api/textDocumentTypes.ts",
        "src/api/util.ts",
        "src/api/viewerTypes.ts",
        "src/auth.ts",
        "src/backend/errors.ts",
        "src/backend/file.ts",
        "src/backend/repo.ts",
        "src/backend/settings.ts",
        "src/codeintel/api.ts",
        "src/codeintel/legacy-extensions/api.ts",
        "src/codeintel/legacy-extensions/indicators.ts",
        "src/codeintel/legacy-extensions/language-specs/comments.ts",
        "src/codeintel/legacy-extensions/language-specs/cpp.ts",
        "src/codeintel/legacy-extensions/language-specs/go.ts",
        "src/codeintel/legacy-extensions/language-specs/identifiers.ts",
        "src/codeintel/legacy-extensions/language-specs/java.ts",
        "src/codeintel/legacy-extensions/language-specs/language-spec.ts",
        "src/codeintel/legacy-extensions/language-specs/languages.ts",
        "src/codeintel/legacy-extensions/language-specs/python.ts",
        "src/codeintel/legacy-extensions/language-specs/typescript.ts",
        "src/codeintel/legacy-extensions/language-specs/util.ts",
        "src/codeintel/legacy-extensions/logging.ts",
        "src/codeintel/legacy-extensions/lsif/api.ts",
        "src/codeintel/legacy-extensions/lsif/definition-hover.ts",
        "src/codeintel/legacy-extensions/lsif/highlights.ts",
        "src/codeintel/legacy-extensions/lsif/implementations.ts",
        "src/codeintel/legacy-extensions/lsif/locations.ts",
        "src/codeintel/legacy-extensions/lsif/providers.ts",
        "src/codeintel/legacy-extensions/lsif/ranges.ts",
        "src/codeintel/legacy-extensions/lsif/references.ts",
        "src/codeintel/legacy-extensions/lsif/stencil.ts",
        "src/codeintel/legacy-extensions/providers.ts",
        "src/codeintel/legacy-extensions/search/config.ts",
        "src/codeintel/legacy-extensions/search/conversion.ts",
        "src/codeintel/legacy-extensions/search/docstrings.ts",
        "src/codeintel/legacy-extensions/search/markdown.ts",
        "src/codeintel/legacy-extensions/search/providers.ts",
        "src/codeintel/legacy-extensions/search/queries.ts",
        "src/codeintel/legacy-extensions/search/settings.ts",
        "src/codeintel/legacy-extensions/search/squirrel.ts",
        "src/codeintel/legacy-extensions/search/tokens.ts",
        "src/codeintel/legacy-extensions/telemetry.ts",
        "src/codeintel/legacy-extensions/util.ts",
        "src/codeintel/legacy-extensions/util/api.ts",
        "src/codeintel/legacy-extensions/util/graphql.ts",
        "src/codeintel/legacy-extensions/util/helpers.ts",
        "src/codeintel/legacy-extensions/util/ix.ts",
        "src/codeintel/legacy-extensions/util/promise.ts",
        "src/codeintel/legacy-extensions/util/uri.ts",
        "src/codeintel/scip.ts",
        "src/codeintel/searchContext.ts",
        "src/commandPalette/CommandList.tsx",
        "src/commandPalette/EmptyCommandList.tsx",
        "src/commandPalette/EmptyCommandListContainer/EmptyCommandListContainer.tsx",
        "src/commandPalette/EmptyCommandListContainer/index.ts",
        "src/commands/commands.ts",
        "src/components/CodeMirrorEditor.ts",
        "src/components/HighlightedMatches.tsx",
        "src/components/MonacoEditor.tsx",
        "src/components/Path.tsx",
        "src/components/PrefetchableFile.tsx",
        "src/components/RepoLink.tsx",
        "src/components/VirtualList.tsx",
        "src/components/icons.tsx",
        "src/components/languageIcons.tsx",
        "src/components/linkPreviews/linkPreviews.ts",
        "src/components/ranking/LineRanking.ts",
        "src/components/ranking/PerFileResultRanking.ts",
        "src/components/ranking/PerFileResultRankingTestHelpers.ts",
        "src/components/ranking/ZoektRanking.ts",
        "src/components/utils/size.ts",
        "src/contributions/contributions.ts",
        "src/extensions/controller.ts",
        "src/extensions/createLazyLoadedController.ts",
        "src/extensions/createSyncLoadedController.ts",
        "src/extensions/devtools/ActiveExtensionsPanel.tsx",
        "src/extensions/devtools/index.tsx",
        "src/extensions/extension.ts",
        "src/extensions/extensionManifest.ts",
        "src/extensions/extensions.ts",
        "src/extensions/helpers.ts",
        "src/globals.d.ts",
        "src/hover/CopyLinkIcon.tsx",
        "src/hover/HoverOverlay.fixtures.ts",
        "src/hover/HoverOverlay.tsx",
        "src/hover/HoverOverlay.types.ts",
        "src/hover/HoverOverlayAlerts/HoverOverlayAlerts.tsx",
        "src/hover/HoverOverlayAlerts/index.ts",
        "src/hover/HoverOverlayContents/HoverOverlayContent/HoverOverlayContent.tsx",
        "src/hover/HoverOverlayContents/HoverOverlayContent/index.ts",
        "src/hover/HoverOverlayContents/HoverOverlayContents.tsx",
        "src/hover/HoverOverlayContents/index.ts",
        "src/hover/HoverOverlayLogo/HoverOverlayLogo.tsx",
        "src/hover/HoverOverlayLogo/index.ts",
        "src/hover/actions.ts",
        "src/hover/helpers.ts",
        "src/hover/useLogTelemetryEvent.ts",
        "src/keyboardShortcuts.ts",
        "src/keyboardShortcuts/keyboardShortcuts.ts",
        "src/keyboardShortcuts/useKeyboardShortcut.ts",
        "src/languages.ts",
        "src/notifications/NotificationItem.tsx",
        "src/notifications/Notifications.tsx",
        "src/notifications/notification.ts",
        "src/platform/context.ts",
        "src/polyfills/configure-core-js.ts",
        "src/polyfills/index.ts",
        "src/polyfills/polyfill.ts",
        "src/polyfills/vendor/eventSource.d.ts",
        "src/react-shortcuts/Shortcut.tsx",
        "src/react-shortcuts/ShortcutManager.tsx",
        "src/react-shortcuts/ShortcutProvider.tsx",
        "src/react-shortcuts/index.ts",
        "src/react-shortcuts/keys.ts",
        "src/schema/extensionSchema.ts",
        "src/search/query/completion.ts",
        "src/search/query/completion-utils.ts",
        "src/search/query/decoratedToken.ts",
        "src/search/query/diagnostics.ts",
        "src/search/query/filters.ts",
        "src/search/query/hover.ts",
        "src/search/query/languageFilter.ts",
        "src/search/query/metrics.ts",
        "src/search/query/monaco.ts",
        "src/search/query/parser.ts",
        "src/search/query/parserFuzz.ts",
        "src/search/query/patternMatcher.ts",
        "src/search/query/predicates.ts",
        "src/search/query/printer.ts",
        "src/search/query/providers.ts",
        "src/search/query/providers-utils.ts",
        "src/search/query/query.ts",
        "src/search/query/scanner.ts",
        "src/search/query/selectFilter.ts",
        "src/search/query/token.ts",
        "src/search/query/transformer.ts",
        "src/search/query/validate.ts",
        "src/search/query/visitor.ts",
        "src/search/stream.ts",
        "src/search/suggestions/index.ts",
        "src/settings/edit.ts",
        "src/settings/settings.ts",
        "src/settings/temporary/TemporarySettings.ts",
        "src/settings/temporary/TemporarySettingsProvider.tsx",
        "src/settings/temporary/TemporarySettingsStorage.ts",
        "src/settings/temporary/diffMode.ts",
        "src/settings/temporary/index.ts",
        "src/settings/temporary/migrateLocalStorageToTemporarySettings.ts",
        "src/settings/temporary/recentSearches.ts",
        "src/settings/temporary/searchSidebar.ts",
        "src/settings/temporary/testUtils.tsx",
        "src/settings/temporary/tourState.ts",
        "src/settings/temporary/useTemporarySetting.ts",
        "src/symbols/SymbolIcon.tsx",
        "src/symbols/SymbolKind.tsx",
        "src/symbols/SymbolTag.tsx",
        "src/telemetry/telemetryService.ts",
        "src/theme.ts",
        "src/tracking/event-log-creators.ts",
        "src/tracking/utm.ts",
        "src/types/core-js/configurator.d.ts",
        "src/types/jasmine/index.d.ts",
        "src/types/puppeteer-firefox/index.d.ts",
        "src/types/storybook-chromatic/index.d.ts",
        "src/types/string-score/index.d.ts",
        "src/types/web-ext/index.d.ts",
        "src/util/dom.ts",
        "src/util/globbing.ts",
        "src/util/lazyComponent.tsx",
        "src/util/url.ts",
        "src/util/useInputValidation.ts",
    ],
    deps = [
        ":module_style_typings",
        ":src/graphql-operations.ts",
        "//:node_modules/@apollo/client",
        "//:node_modules/@codemirror/language",
        "//:node_modules/@codemirror/state",
        "//:node_modules/@codemirror/view",
        "//:node_modules/@lezer/highlight",
        "//:node_modules/@mdi/js",
        "//:node_modules/@microsoft/fetch-event-source",
        "//:node_modules/@sourcegraph/client-api",
        "//:node_modules/@sourcegraph/codeintellify",
        "//:node_modules/@sourcegraph/common",
        "//:node_modules/@sourcegraph/extension-api-classes",
        "//:node_modules/@sourcegraph/http-client",
        "//:node_modules/@sourcegraph/search",
        "//:node_modules/@sourcegraph/template-parser",
        "//:node_modules/@sourcegraph/wildcard",
        "//:node_modules/@storybook/addon-actions",
        "//:node_modules/@types/classnames",
        "//:node_modules/@types/history",
        "//:node_modules/@types/js-base64",
        "//:node_modules/@types/lodash",
        "//:node_modules/@types/lru-cache",
        "//:node_modules/@types/node",
        "//:node_modules/@types/puppeteer",
        "//:node_modules/@types/react",
        "//:node_modules/classnames",
        "//:node_modules/comlink",
        "//:node_modules/core-js",
        "//:node_modules/fast-json-stable-stringify",
        "//:node_modules/history",
        "//:node_modules/js-base64",
        "//:node_modules/lodash",
        "//:node_modules/lru-cache",
        "//:node_modules/mdi-react",
        "//:node_modules/message-port-polyfill",
        "//:node_modules/minimatch",
        "//:node_modules/monaco-editor",
        "//:node_modules/puppeteer",
        "//:node_modules/react",
        "//:node_modules/react-visibility-sensor",
        "//:node_modules/regexpp",
        "//:node_modules/rxjs",
        "//:node_modules/string-score",
        "//:node_modules/tabbable",
        "//:node_modules/tagged-template-noop",
        "//:node_modules/ts-key-enum",
        "//:node_modules/use-deep-compare-effect",
    ],
)

ts_project(
    name = "shared_tests",
    testonly = True,
    srcs = [
        "src/actions/ActionItem.story.tsx",
        "src/actions/ActionItem.test.tsx",
        "src/actions/ActionsNavItems.test.tsx",
        "src/api/client/mainthread-api.test.ts",
        "src/api/client/types/textDocument.test.ts",
        "src/api/extension/api/callViewProvidersInParallel.test.ts",
        "src/api/extension/api/context/context.test.ts",
        "src/api/extension/api/contribution.test.ts",
        "src/api/extension/api/decorations.test.ts",
        "src/api/extension/api/textDocument.test.ts",
        "src/api/extension/api/utils/prefixSumComputer.test.ts",
        "src/api/extension/api/utils/wordHelpers.test.ts",
        "src/api/extension/test/activation.test.ts",
        "src/api/extension/test/extensionHost.configuration.test.ts",
        "src/api/extension/test/extensionHost.decorations.test.ts",
        "src/api/extension/test/extensionHost.documentHighlights.test.ts",
        "src/api/extension/test/extensionHost.hover.test.ts",
        "src/api/extension/test/extensionHost.logging.test.ts",
        "src/api/extension/test/extensionHost.providers.test.ts",
        "src/api/extension/test/extensionHost.search.test.ts",
        "src/api/integration-test/codeEditor.test.ts",
        "src/api/integration-test/commands.test.ts",
        "src/api/integration-test/configuration.test.ts",
        "src/api/integration-test/content.test.ts",
        "src/api/integration-test/documents.test.ts",
        "src/api/integration-test/internal.test.ts",
        "src/api/integration-test/languageFeatures.test.ts",
        "src/api/integration-test/roots.test.ts",
        "src/api/integration-test/search.test.ts",
        "src/api/integration-test/selections.test.ts",
        "src/api/integration-test/views.test.ts",
        "src/api/integration-test/windows.test.ts",
        "src/api/util.test.ts",
        "src/backend/errors.test.ts",
        "src/codeintel/legacy-extensions/init.test.ts",
        "src/codeintel/legacy-extensions/language-specs/cpp.test.ts",
        "src/codeintel/legacy-extensions/language-specs/go.test.ts",
        "src/codeintel/legacy-extensions/language-specs/java.test.ts",
        "src/codeintel/legacy-extensions/language-specs/python.test.ts",
        "src/codeintel/legacy-extensions/language-specs/spec.test.ts",
        "src/codeintel/legacy-extensions/language-specs/typescript.test.ts",
        "src/codeintel/legacy-extensions/lsif/definition-hover.test.ts",
        "src/codeintel/legacy-extensions/lsif/highlights.test.ts",
        "src/codeintel/legacy-extensions/lsif/locations.test.ts",
        "src/codeintel/legacy-extensions/lsif/providers.test.ts",
        "src/codeintel/legacy-extensions/lsif/ranges.test.ts",
        "src/codeintel/legacy-extensions/lsif/references.test.ts",
        "src/codeintel/legacy-extensions/lsif/stencil.test.ts",
        "src/codeintel/legacy-extensions/lsif/util.test.ts",
        "src/codeintel/legacy-extensions/providers.test.ts",
        "src/codeintel/legacy-extensions/search/conversion.test.ts",
        "src/codeintel/legacy-extensions/search/docstrings.test.ts",
        "src/codeintel/legacy-extensions/search/markdown.test.ts",
        "src/codeintel/legacy-extensions/search/providers.test.ts",
        "src/codeintel/legacy-extensions/search/queries.test.ts",
        "src/codeintel/legacy-extensions/search/tokens.test.ts",
        "src/codeintel/legacy-extensions/util/ix.test.ts",
        "src/codeintel/legacy-extensions/util/uri.test.ts",
        "src/commandPalette/CommandList.test.ts",
        "src/commands/commands.test.ts",
        "src/components/HighlightedMatches.test.tsx",
        "src/components/Path.test.tsx",
        "src/components/RepoLink.test.tsx",
        "src/components/linkPreviews/linkPreviews.test.ts",
        "src/components/ranking/LineRanking.test.tsx",
        "src/components/ranking/ZoektRanking.test.tsx",
        "src/contributions/contributions.test.ts",
        "src/extensions/extension.test.ts",
        "src/extensions/helpers.test.ts",
        "src/hover/HoverOverlay.story.tsx",
        "src/hover/HoverOverlay.test.tsx",
        "src/hover/actions.test.ts",
        "src/keyboardShortcuts/useKeyboardShortcut.test.tsx",
        "src/languages.test.ts",
        "src/notifications/NotificationItem.story.tsx",
        "src/react-shortcuts/ShortcutManager.test.tsx",
        "src/search/query/completion.test.ts",
        "src/search/query/decoratedToken.test.ts",
        "src/search/query/diagnostics.test.ts",
        "src/search/query/filters.test.ts",
        "src/search/query/hover.test.ts",
        "src/search/query/languageFilter.test.ts",
        "src/search/query/metrics.test.ts",
        "src/search/query/parser.test.ts",
        "src/search/query/patternMatcher.test.ts",
        "src/search/query/predicates.test.ts",
        "src/search/query/printer.test.ts",
        "src/search/query/providers-utils.test.ts",
        "src/search/query/scanner.test.ts",
        "src/search/query/selectFilter.test.ts",
        "src/search/query/transformer.test.ts",
        "src/search/query/validate.test.ts",
        "src/search/query/visitor.test.ts",
        "src/settings/settings.test.ts",
        "src/settings/temporary/useTemporarySetting.test.tsx",
        "src/symbols/SymbolTag.story.tsx",
        "src/testing/MockIntersectionObserver.ts",
        "src/testing/accessibility.ts",
        "src/testing/apollo/createGraphQLClientGetter.ts",
        "src/testing/apollo/index.ts",
        "src/testing/apollo/mockedTestProvider.tsx",
        "src/testing/config.ts",
        "src/testing/console.ts",
        "src/testing/coverage.ts",
        "src/testing/dom-test-helpers.ts",
        "src/testing/dom-utils.ts",
        "src/testing/driver.ts",
        "src/testing/integration/context.ts",
        "src/testing/integration/graphQlResults.ts",
        "src/testing/integration/mockExtension.ts",
        "src/testing/integration/polly/CdpAdapter.ts",
        "src/testing/screenshotReporter.ts",
        "src/testing/searchContexts/testHelpers.ts",
        "src/testing/searchTestHelpers.ts",
        "src/testing/simulateMenuItemClick.ts",
        "src/testing/utils.ts",
        "src/tracking/utm.test.ts",
        "src/util/dom.test.ts",
        "src/util/url.test.ts",
        "src/util/useInputValidation.test.ts",
    ],
    deps = [
        ":shared_lib",
        ":src/graphql-operations.ts",
        "//:node_modules/@apollo/client",
        "//:node_modules/@atlassian/aui",
        "//:node_modules/@axe-core/puppeteer",
        "//:node_modules/@percy/puppeteer",
        "//:node_modules/@pollyjs/adapter",
        "//:node_modules/@pollyjs/core",
        "//:node_modules/@pollyjs/persister-fs",
        "//:node_modules/@sourcegraph/branded",
        "//:node_modules/@sourcegraph/browser",
        "//:node_modules/@sourcegraph/build-config",
        "//:node_modules/@sourcegraph/client-api",
        "//:node_modules/@sourcegraph/codeintellify",
        "//:node_modules/@sourcegraph/common",
        "//:node_modules/@sourcegraph/extension-api-classes",
        "//:node_modules/@sourcegraph/extension-api-stubs",
        "//:node_modules/@sourcegraph/http-client",
        "//:node_modules/@sourcegraph/template-parser",
        "//:node_modules/@sourcegraph/wildcard",
        "//:node_modules/@storybook/addon-actions",
        "//:node_modules/@testing-library/react",
        "//:node_modules/@testing-library/user-event",
        "//:node_modules/@types/classnames",
        "//:node_modules/@types/expect",
        "//:node_modules/@types/history",
        "//:node_modules/@types/lodash",
        "//:node_modules/@types/mime-types",
        "//:node_modules/@types/mocha",
        "//:node_modules/@types/mock-require",
        "//:node_modules/@types/node",
        "//:node_modules/@types/puppeteer",
        "//:node_modules/@types/react",
        "//:node_modules/@types/react-router-dom",
        "//:node_modules/@types/sinon",
        "//:node_modules/@types/uuid",
        "//:node_modules/chalk",
        "//:node_modules/classnames",
        "//:node_modules/comlink",
        "//:node_modules/date-fns",
        "//:node_modules/delay",
        "//:node_modules/expect",
        "//:node_modules/history",
        "//:node_modules/jest-mock-extended",
        "//:node_modules/jsonc-parser",
        "//:node_modules/lodash",
        "//:node_modules/mime-types",
        "//:node_modules/mocha",
        "//:node_modules/mock-require",
        "//:node_modules/monaco-editor",
        "//:node_modules/mz",
        "//:node_modules/p-retry",
        "//:node_modules/p-timeout",
        "//:node_modules/prettier",
        "//:node_modules/puppeteer",
        "//:node_modules/react",
        "//:node_modules/react-router-dom",
        "//:node_modules/react-router-dom-v5-compat",
        "//:node_modules/rxjs",
        "//:node_modules/sinon",
        "//:node_modules/sourcegraph",
        "//:node_modules/string-width",
        "//:node_modules/term-size",
        "//:node_modules/ts-key-enum",
        "//:node_modules/uuid",
    ],
)

npm_package(
    name = "shared",
    srcs = [
        "package.json",
        ":shared_lib",
    ],
)

sass_library(
    name = "global-style-vars",
    srcs = [
        "src/global-styles/icons.scss",
    ],
    visibility = ["//visibility:public"],
)
